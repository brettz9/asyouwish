<!DOCTYPE html>
<html><head><meta charset="utf-8" />
<script>
/*globals AsYouWish*/
'use strict';
/**
AsYouWish.removePrivs(); // Only usable on current site
alert("Privileges successfully reset!");
throw '';
*/

/*
This same page:
1) Registers "add-on" for restart (todo)
2) Adds widget
3) Adds panel content of widget
4) Adds events (including privileged) to respond to panel requests

0) Currently, besides code fix for widget.js, just requires approval BEFORE registration (find a way to do otherwise); why is this line not getting it?
    a) mainWindow = getMainWindowFromChildWindow(subject);
*/

var Panel,
    errBack = function errBack (error, error2, error3) {
        document.getElementById('errs').
            appendChild(document.createTextNode('Error type: ' + error + (error2 ? ' ' + error2 : '') + (error3 ? ' ' + error3 : '') + '\n'));
        document.getElementById('errs').
            appendChild(document.createElement('br'));
    };

window.addEventListener('unload', function () {
    console.log('unloaded addon demo');
    Panel.postMessage('unloaded');
});
    
window.addEventListener('DOMContentLoaded', function () {
    var $ = function (sel) {
        return document.querySelector(sel);
    };
    // errBack = false; // Try default (only alerts when refused)
    function clipboard () {
    
    AsYouWish.requestPrivs(['clipboard', 'windows'], function (clip, win) {
        try {
            console.log('ok1');
            Panel.postMessage(
                'In the clipboard:' + clip.get()
            );
        }
        catch (e) {
            console.log('err1'+e);
            Panel.postMessage('Page callback error11' + e);
        }
    }, errBack);
}

//clipboard(); // Should ensure we have all permissions first, as otherwise, this will not work from a hidden window
    try {
        AsYouWish.requestPrivs(['widget', 'panel'], function (widget, panel) {
            try {
                Panel = panel.Panel({
                    width: 180,
                    height: 180,
                    //contentURL: 'http://127.0.0.1/ayw/demos/requestPrivs-options-content.html'
                    //contentScript: 'window.addEventListener("load", function () {document.body.innerHTML= "<b>hello!<\/b>"});' // This works as a replacement of contentURL (not DOMContentLoaded)
                    onMessage: function () {
                        console.log('inside onMessage');
                        clipboard();
                    },
                    contentScript: errBack.toString() + '\n' + clipboard.toString() + 
                    'window.addEventListener("click", function () {self.postMessage();});' +
                    'self.on("message", function (msg) {alert(msg);});' + // we add events here, as adding in the HTML in the next line does not allow privileged access
                    '\nwindow.addEventListener("load", function () {document.body.innerHTML= "' + document.body.innerHTML.replace(/"/g, '\\"').replace(/\r?\n/g, ' ') + '"});'
                })
                widget.Widget({
                    id: "brettz9test",
                    label: "My testing Widget",
                    contentURL: "http://www.mozilla.org/favicon.ico",
                    //content: document.body.innerHTML // This didn't work well, as this provides HTML to show ON add-on bar--we instead want panel and panel only support contentURL, not content (though as below, contentScript can be used to inject content)
                    panel: Panel
                });
            }
            catch (e) {
                alert('Page callback error' + e + e.lineNumber + e.fileName);
            }

        }, errBack);

    } catch (e) {
        alert('page error: ' + e);
    }
});
</script>
</head><body>
<div id="errs"></div>

 <div>
This is a test2 <input type="checkbox" />
</div>

</body></html>